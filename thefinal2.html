<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記帳系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: aliceblue;
            background-color: #333;
        }

        #chartContainer {
            overflow-x: auto;
            width: 100%;
            height: 300px;
            margin-bottom: 30px;
           
        }

        #lineChart {
            min-width: 1200px;
        }

        #pieChartContainer {
            margin-top: 20px;
            width: 100%;
            height: 300px;
        }

        .font-selector {
            margin-bottom: 20px;
        }

        .category-options {
            margin-bottom: 10px;
        }

        .category-options label {
            margin-right: 15px;
        }
        #comparison-chart
        {
            display: block;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .charts-container {
            margin-bottom: 300px;
        }

        .charts-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            opacity: 0;
            transition: all 3s ease;
            max-height: 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .charts-row.visible {
            opacity: 1;
            max-height: 400px;
            margin-bottom: 20px;
        }

        #pieChartContainer {
            flex: 1;
            height: 300px;
            margin-top: 0;
        }

        #comparison-chart-wrapper {
            flex: 1;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        #comparison-chart {
            margin: 0;
            height: 300px;
        }

        #comparison-result {
            margin-top: 10px;
            text-align: center;
        }

        .charts-container {
            margin-bottom: 0;
            transition: margin-bottom 0.3s ease;
        }

        .charts-container.expanded {
            margin-bottom: 20px;
        }

        .font-selector {
            position: fixed;
            top: 50px;
            right: 50px;
            z-index: 1000;
        }

        #fontSelector{
            padding: 8px;
            border-radius: 4px;
            background-color:#333;
            color:aliceblue ;
            border: none;
          
        }

        .month-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .month-selector button {
            padding: 5px 15px;
            margin: 0 10px;
            background-color: #444;
            color: aliceblue;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .month-selector button:hover {
            background-color: #555;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #444;
            border-radius: 8px;
            overflow: hidden;
        }

        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #555;
        }

        .expense-table th {
            background-color: #2c2c2c;
            font-weight: bold;
        }

        .expense-table tr:hover {
            background-color: #505050;
        }

        .expense-table input[type="checkbox"] {
            cursor: pointer;
        }

        .no-expenses {
            text-align: center;
            padding: 20px;
            color: #888;
        }
    </style>
</head>

<body>
    <h1>local accounting system</h1>
    <p id="todayDate"></p>
    <h2>月總結</h2>
    <p id="monthlyTotal"></p>
    <h1 id="monthlyRemaining"></h1>
    <div class="font-selector">
        <select id="fontSelector" onchange="changeFont()">
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Georgia">Georgia</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Verdana">Verdana</option>
        </select>
    </div>

    <div class="charts-container">
        <div class="month-selector">
            <button onclick="changeMonth(-1)">上個月</button>
            <span id="currentMonthDisplay"></span>
            <button onclick="changeMonth(1)">下個月</button>
        </div>
        <div id="chartContainer"onmouseover="showOtherCharts()" onmouseleave="hideOtherCharts()">
            <canvas id="lineChart"></canvas>
        </div>

        <div class="charts-row" id="additional-charts">
            <div id="pieChartContainer" onmouseover="showOtherCharts()" onmouseleave="hideOtherCharts()">
                <canvas id="pieChart"></canvas>
            </div>
            
            <div id="comparison-chart-wrapper">
                <canvas id="comparison-chart" onmouseover="showOtherCharts()" onmouseleave="hideOtherCharts()"></canvas>
                <h3 id="comparison-result"></h3>
            </div>
        </div>
    </div>

    <h2>新增預約扣款</h2>
    <div>
        <input type="date" id="scheduledDate" placeholder="預約日期">
        <input type="number" id="scheduledAmount" placeholder="金額">
        <select id="scheduledCategory">
            <option value="交通">交通</option>
            <option value="吃飯">吃飯</option>
            <option value="投資">投資</option>
            <option value="零食">零食</option>
        </select>
        <input type="text" id="scheduledNote" placeholder="備註 (可選)">
        <button id="addScheduledBtn" onclick="addScheduledExpense()">新增預約扣款</button>
    </div>

    <h2>新增支出</h2>
    <div class="category-options">
        <label><input type="radio" name="expenseCategory" value="交通"> 交通</label>
        <label><input type="radio" name="expenseCategory" value="吃飯"> 吃飯</label>
        <label><input type="radio" name="expenseCategory" value="投資"> 投資</label>
        <label><input type="radio" name="expenseCategory" value="零食"> 零食</label>
        <label><input type="radio" name="expenseCategory" value="薪水"> 薪水</label>
    </div>
    <input type="number" id="expenseAmount" placeholder="金額">
    <input type="text" id="expenseNote" placeholder="備註 (可選)">
    <button id="addExpenseBtn" onclick="addExpense()">新增支出</button>
    <div>
        <label for="category-select">選擇類別：</label>
        <select id="category-select">
            <option value="">全部</option>
            <!-- 程式會動態填充選項 -->
        </select>
    </div>

    <h2>今日支出</h2>
    <button id="clearSelectedBtn" onclick="clearSelected()">清除勾選的今日項目</button>
    <div id="expenseList"></div>
    

   
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartInstance = null;
        let pieChartInstance = null;
        let currentDisplayMonth = new Date(); // 當前顯示的月份

        function changeFont() {
            const selectedFont = document.getElementById("fontSelector").value;
            document.body.style.fontFamily = selectedFont;

            if (chartInstance) {
                chartInstance.options.plugins.title.font.family = selectedFont;
                chartInstance.options.plugins.legend.labels.font.family = selectedFont;
                chartInstance.update();
            }

            if (pieChartInstance) {
                pieChartInstance.options.plugins.title.font.family = selectedFont;
                pieChartInstance.options.plugins.legend.labels.font.family = selectedFont;
                pieChartInstance.update();
            }
        }

        function renderChart() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            
            // 獲取當前月份的天數
            const daysInMonth = new Date(
                currentDisplayMonth.getFullYear(),
                currentDisplayMonth.getMonth() + 1,
                0
            ).getDate();
            
            const selectedMonthData = getMonthlyData(data, currentDisplayMonth, false);
            const selectedMonthWithScheduled = getMonthlyData(data, currentDisplayMonth, true);
            
            const lastMonth = new Date(currentDisplayMonth);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthData = getMonthlyData(data, lastMonth, false);

            const ctx = document.getElementById("lineChart").getContext("2d");

            if (chartInstance) {
                chartInstance.data.labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                chartInstance.data.datasets[0].data = selectedMonthData.slice(0, daysInMonth);
                chartInstance.data.datasets[1].data = lastMonthData.slice(0, daysInMonth);
                chartInstance.data.datasets[2].data = selectedMonthWithScheduled.slice(0, daysInMonth);
                chartInstance.options.plugins.title.text = 
                    `${currentDisplayMonth.getFullYear()}年${currentDisplayMonth.getMonth() + 1}月支出趨勢圖`;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: daysInMonth }, (_, i) => i + 1),
                        datasets: [
                            {
                                label: "本月 (實際支出)",
                                data: selectedMonthData.slice(0, daysInMonth),
                                borderColor: "orange",
                                fill: false
                            },
                            {
                                label: "上月 (實際支出)",
                                data: lastMonthData.slice(0, daysInMonth),
                                borderColor: "yellow",
                                fill: false
                            },
                            {
                                label: "本月 (含預約扣款)",
                                data: selectedMonthWithScheduled.slice(0, daysInMonth),
                                borderColor: "blue",
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '日期 (日)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金額 (元)'
                                },
                                ticks: {
                                    stepSize: 1000
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    font: {
                                        family: "Arial"
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: "月支出趨勢圖",
                                font: {
                                    family: "Arial"
                                }
                            }
                        }
                    }
                });
            }
        }
        // 初始化，填充下拉選單
        function initializeCategorySelector() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const uniqueCategories = Array.from(new Set(data.map(expense => expense.category)));
            const selectElement = document.getElementById("category-select");
            selectElement.innerHTML = ""; // 確保不會重複添加選項
            const allOption = document.createElement("option");
            allOption.value = "";
            allOption.textContent = "全部";
            selectElement.appendChild(allOption);
            uniqueCategories.forEach(category => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });

            // 監聽下拉選單的變化
            selectElement.addEventListener("change", () => {
                generateComparison(selectElement.value);
            });

            // 初次生成圖表
            generateComparison("");
        }
        // 根據選擇的類別生成圖表
        function generateComparison(selectedCategory) {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            
            // 使用 currentDisplayMonth 作為當前月份
            const currentMonth = currentDisplayMonth.toISOString().slice(0, 7);
            
            // 計算上個月
            const lastMonth = new Date(currentDisplayMonth);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().slice(0, 7);

            // 過濾本月與上月數據
            const currentMonthData = data.filter(
                expense =>
                    expense.date.startsWith(currentMonth) &&
                    (selectedCategory === "" || expense.category === selectedCategory)
            );
            const lastMonthData = data.filter(
                expense =>
                    expense.date.startsWith(lastMonthStr) &&
                    (selectedCategory === "" || expense.category === selectedCategory)
            );

            // 計算每個類別的支出總額
            function calculateCategoryTotals(expenses) {
                return expenses.reduce((totals, expense) => {
                    if (!totals[expense.category]) {
                        totals[expense.category] = 0;
                    }
                    const amount = expense.category === "薪水" ? 
            expense.amount : Math.abs(expense.amount);
        totals[expense.category] += amount;
        return totals;
                }, {});
            }

            const currentMonthTotals = calculateCategoryTotals(currentMonthData);
            const lastMonthTotals = calculateCategoryTotals(lastMonthData);

            // 獲取類別（僅選擇的類別或全部）
            const allCategories = selectedCategory
                ? [selectedCategory]
                : Array.from(new Set([...Object.keys(currentMonthTotals), ...Object.keys(lastMonthTotals)]));

            // 准備圖表數據
            const currentMonthValues = allCategories.map(category => currentMonthTotals[category] || 0);
            const lastMonthValues = allCategories.map(category => lastMonthTotals[category] || 0);

            // 計算百分比變化
            const percentageChanges = allCategories.map(category => {
                const lastMonthValue = lastMonthTotals[category] || 0;
                const currentMonthValue = currentMonthTotals[category] || 0;
                if (lastMonthValue === 0) {
                    return currentMonthValue === 0 ? 0 : 100; // 如果上月和本月都是 0，變化為 0%；如果上月是 0，本月非 0，變化為 100%
                }
                return ((currentMonthValue - lastMonthValue) / Math.abs(lastMonthValue)) * 100;
            });

            // 檢查是否有現存的圖表，並銷毀它
            const chartCanvas = document.getElementById("comparison-chart");
            if (chartCanvas.chartInstance) {
                chartCanvas.chartInstance.destroy();
            }
            const ctx = document.getElementById("comparison-chart").getContext("2d");
            const currentChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: allCategories,
                    datasets: [
                        {
                            label: "本月",
                            data: currentMonthValues,
                            backgroundColor: "orange",
                            borderWidth: 1,
                            borderRadius: 15, // 設定柱狀圖圓角
                            borderSkipped: false, // 使柱狀圖的頭尾圓潤
                        },
                        {
                            label: "上月",
                            data: lastMonthValues,
                            backgroundColor: "yellow",
                            borderWidth: 1,
                            borderRadius: 15,
                            borderSkipped: false,
                        },
                    ],
                },
                options: {
                    indexAxis: "y", // 橫向柱狀圖
                    responsive: true,
        
                    scales: {
                        x: {
                            beginAtZero: true,
                            reverse: true, // X 軸反轉，實現由右到左
                        },
                        y: {
                            beginAtZero: true,
                        },
                    },
                },
            });
            // 保存當前圖表實例到畫布元素
            document.getElementById("comparison-chart").chartInstance = currentChart;
            // 顯示百分比比較結果
            const comparisonResult = allCategories
                .map((category, index) => {
                    const percentage = percentageChanges[index].toFixed(2); // 保留兩位小數
                    return `${category}: ${percentage >= 0 ? "+" : ""}${percentage}%`;
                })
                .join("<br>");
            document.getElementById("comparison-result").innerHTML = "比較結果（百分比）：<br>" + comparisonResult;
        }

        // 初始化
        initializeCategorySelector();



        function addExpense() {
            const expenseAmount = parseFloat(document.getElementById("expenseAmount").value);
            const expenseNote = document.getElementById("expenseNote").value || "無備註";
            const expenseCategory = document.querySelector("input[name='expenseCategory']:checked");

            if (!expenseAmount || isNaN(expenseAmount)) {
                alert("請輸入有效的金額！");
                return;
            }

            if (!expenseCategory) {
                alert("請選擇一個類別！");
                return;
            }

            const isSalary = expenseCategory.value === "薪水";

            const expense = {
                date: new Date().toISOString().split("T")[0],
                amount: isSalary ? Math.abs(expenseAmount) : -Math.abs(expenseAmount),
                category: expenseCategory.value,
                note: expenseNote,
                type: "actual" // 實際支出
            };

            let data = JSON.parse(localStorage.getItem("expenses")) || [];
            data.push(expense);
            localStorage.setItem("expenses", JSON.stringify(data));

            alert("支出已新增！");

            // 清空表單輸入欄位
            document.getElementById("expenseAmount").value = "";
            document.getElementById("expenseNote").value = "";
            if (expenseCategory) {
                expenseCategory.checked = false; // 清除選中類別
            }

            // 更新視圖
            renderTodayExpenses();
            displaySummary();
            renderChart();
            renderPieChart();
           initializeCategorySelector(); 
        }


        function addScheduledExpense() {
            const scheduledDateInput = document.getElementById("scheduledDate");
            const scheduledDate = scheduledDateInput.value;
            const scheduledAmount = parseFloat(document.getElementById("scheduledAmount").value);
            const scheduledCategoryInput = document.getElementById("scheduledCategory");
            const scheduledCategory = scheduledCategoryInput ? scheduledCategoryInput.value : "預約扣款";
            const scheduledNote = document.getElementById("scheduledNote").value || "無備註";

            // 日期檢查 - 前端限制
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 今日日期重置時間為 00:00:00
            const inputDate = new Date(scheduledDate);

            if (!scheduledDate || inputDate <= today) {
                alert("預約扣款的日期不能為當日或之前！請重新輸入有效日期。");
                return;
            }

            // 金額檢查
            if (isNaN(scheduledAmount) || scheduledAmount <= 0) {
                alert("請輸入有效的扣款金額！");
                return;
            }

            // 建立預約扣款資料
            const scheduledExpense = {
                date: scheduledDate,
                amount: -Math.abs(scheduledAmount),
                note: scheduledNote,
                category: scheduledCategory,
                type: "scheduled"
            };

            // 儲存本地資料
            let data = JSON.parse(localStorage.getItem("expenses")) || [];
            data.push(scheduledExpense);
            localStorage.setItem("expenses", JSON.stringify(data));

            alert("預約扣款已成功新增");
            renderChart();
            renderPieChart(); // 即時更新圓餅圖
            renderScheduledExpenses(); // 即時更新預約列表
            displaySummary();
            addScheduledExpense()
        }

        // 在 HTML 輸入中直接限制日期選擇
        document.addEventListener("DOMContentLoaded", () => {
            const scheduledDateInput = document.getElementById("scheduledDate");
            const today = new Date().toISOString().split("T")[0]; // 取得今日的 YYYY-MM-DD 格式
            scheduledDateInput.setAttribute("min", today); // 限制最小日期為今日
        });


        function renderPieChart() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            // 使用 currentDisplayMonth 替代當前月份
            const currentMonth = currentDisplayMonth.toISOString().slice(0, 7);
            const today = new Date().toISOString().split("T")[0];

            // 過濾選中月份的資料
            const filteredData = data.filter(expense => {
                if (expense.category === "薪水") return false;
                if (expense.type === "scheduled" && expense.date === today) return true;
                return expense.date.startsWith(currentMonth);
            });

            // 計算類別總支出
            const categoryTotals = {};
            filteredData.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + Math.abs(expense.amount);
            });

            const ctx = document.getElementById("pieChart").getContext("2d");

            if (pieChartInstance) {
                pieChartInstance.data.labels = Object.keys(categoryTotals);
                pieChartInstance.data.datasets[0].data = Object.values(categoryTotals);
                pieChartInstance.update();
            } else {
                pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            data: Object.values(categoryTotals),
                            backgroundColor: ["#640D5F", "#D91656", "#EB5B00", "#FFB200", "#0066CC"],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: "top",
                                labels: {
                                    font: {
                                        family: "Arial"
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: "本月支出比例 (含今日預約扣款)",
                                font: {
                                    family: "Arial"
                                }
                            }
                        }
                    }
                });
            }
        }


        function renderTodayExpenses() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const selectedMonth = currentDisplayMonth.toISOString().slice(0, 7); // 獲取選中月份 YYYY-MM 格式
            
            // 過濾選中月份的支出
            const monthlyExpenses = data.filter(expense => expense.date.startsWith(selectedMonth));
            
            // 按日期升序排列
            const sortedExpenses = monthlyExpenses.sort((a, b) => new Date(a.date) - new Date(b.date));

            const expenseList = document.getElementById("expenseList");
            
            // 如果該月沒有支出記錄
            if (sortedExpenses.length === 0) {
                expenseList.innerHTML = `<div class="no-expenses">本月尚無支出記錄</div>`;
                return;
            }

            // 生成表格形式的支出列表
            const tableHTML = `
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th>選擇</th>
                            <th>日期</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedExpenses.map((expense, index) => `
                            <tr>
                                <td><input type="checkbox" id="expense-${index}"></td>
                                <td>${expense.date}</td>
                                <td>${expense.type === "scheduled" ? "預約扣款" : "實際支出"}</td>
                                <td>${expense.category}</td>
                                <td>${Math.abs(expense.amount)} 元</td>
                                <td>${expense.note}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;

            expenseList.innerHTML = tableHTML;
        }


        function clearSelected() {
            const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");
            let data = JSON.parse(localStorage.getItem("expenses")) || [];

            checkboxes.forEach(checkbox => {
                const index = checkbox.id.split("-")[1];
                data.splice(index, 1); // 根據索引除對應支出
            });

            localStorage.setItem("expenses", JSON.stringify(data));
            renderTodayExpenses(); // 重新渲染支出列表
            displaySummary(); // 更新月總結
            renderChart(); // 更新折線圖
            renderPieChart(); // 更新圓餅圖
        }

        function renderScheduledExpenses() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const scheduledExpenses = data.filter(expense => expense.type === "scheduled");

            const scheduledList = document.getElementById("scheduledList");

            if (scheduledExpenses.length === 0) {
                scheduledList.innerHTML = "<p>目前無預約扣款項目。</p>";
                return;
            }

            scheduledList.innerHTML = scheduledExpenses.map((expense, index) => `
        <div>
            <input type="checkbox" id="scheduled-${index}">
            日期：${expense.date}，類型：${expense.category}，金額：${Math.abs(expense.amount)} 元
        </div>
    `).join("");
        }

        function displaySummary() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const today = new Date();
            const month = today.toISOString().slice(0, 7);
            const todayDate = today.toISOString().split("T")[0];

            // 當月資料
            const monthlyExpenses = data.filter(expense => expense.date.startsWith(month));

            // 獲取薪水總額
            const salary = monthlyExpenses
                .filter(expense => expense.category === "薪水" && expense.type === "actual")
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 實際支出 (負數，非薪水)
            const actualExpenses = monthlyExpenses
                .filter(expense => expense.type === "actual" && expense.category !== "薪水")
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 當日預約扣款 (負)
            const todayScheduledExpenses = data
                .filter(expense => expense.type === "scheduled" && expense.date === todayDate)
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 剩餘金額 = 薪水 - 實際支出 - 當日預約扣款
            const remaining = salary - Math.abs(actualExpenses) - Math.abs(todayScheduledExpenses);

            // 更新顯示
            document.getElementById("todayDate").textContent = "今日日期：" + todayDate;
            document.getElementById("monthlyTotal").textContent = "本月總消費金額：" + Math.abs(actualExpenses + todayScheduledExpenses) + " 元";
            document.getElementById("monthlyRemaining").textContent = "本月剩餘金額：" + remaining + " 元";
        }


        function init() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const today = new Date().toISOString().split("T")[0];

            // 檢查當日預約扣款，並將其轉為實際支出
            let updated = false;
            data.forEach(expense => {
                if (expense.type === "scheduled" && expense.date === today) {
                    expense.type = "actual"; // 更新為實際支出
                    updated = true;
                }
            });

            if (updated) {
                localStorage.setItem("expenses", JSON.stringify(data)); // 保存變更
            }

            // 依次更新視圖
            renderTodayExpenses();
            displaySummary();
            renderChart();
            renderPieChart(); // 確保圓餅圖更新
            renderScheduledExpenses(); // 更新預約扣款列表
            updateMonthDisplay(); // 添加這行
        }

        init();

        function showOtherCharts() {
            const additionalCharts = document.getElementById('additional-charts');
            const chartsContainer = document.querySelector('.charts-container');
            additionalCharts.classList.add('visible');
            chartsContainer.classList.add('expanded');
        }

        function hideOtherCharts() {
            const additionalCharts = document.getElementById('additional-charts');
            const chartsContainer = document.querySelector('.charts-container');
            additionalCharts.classList.remove('visible');
            chartsContainer.classList.remove('expanded');
        }

        function changeMonth(delta) {
            currentDisplayMonth.setMonth(currentDisplayMonth.getMonth() + delta);
            updateMonthDisplay();
            renderChart();
            renderPieChart();
            generateComparison(document.getElementById("category-select").value);
            renderTodayExpenses();
        }

        function updateMonthDisplay() {
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", 
                               "七月", "八月", "九月", "十月", "十一月", "十二月"];
            document.getElementById("currentMonthDisplay").textContent = 
                `${currentDisplayMonth.getFullYear()}年 ${monthNames[currentDisplayMonth.getMonth()]}`;
        }

        function getMonthlyData(data, date, includeScheduled) {
            const month = date.toISOString().slice(0, 7);
            const today = new Date().toISOString().split("T")[0];
            const daysInMonth = new Date(
                date.getFullYear(),
                date.getMonth() + 1,
                0
            ).getDate();
            
            const dailyTotals = Array(daysInMonth).fill(0);

            data.filter(expense => expense.date.startsWith(month))
                .forEach(expense => {
                    const day = parseInt(expense.date.split("-")[2]);
                    if (!includeScheduled && expense.type === "scheduled" && expense.date !== today) return;
                    if (day <= daysInMonth) { // 確保日期在當月範圍內
                        dailyTotals[day - 1] += expense.amount;
                    }
                });

            return dailyTotals;
        }
    </script>
</body>

</html>
