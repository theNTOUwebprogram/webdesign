<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記帳系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: aliceblue;
            background-color: #333;
        }

        #chartContainer {
            overflow-x: auto;
            width: 100%;
            height: 300px;
            margin-bottom: 30px;

        }

        #lineChart {
            min-width: 1200px;
        }

        #pieChartContainer {
            margin-top: 20px;
            width: 100%;
            height: 300px;
        }

        .font-selector {
            margin-bottom: 20px;
        }

        .category-options {
            margin-bottom: 10px;
        }

        .category-options label {
            margin-right: 15px;
        }

        #comparison-chart {
            display: block;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .charts-container {
            margin-bottom: 300px;
        }

        .charts-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            opacity: 0.0;
            transition: all 3s ease;
            max-height: 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .charts-row.visible {
            opacity: 1;
            max-height: 400px;
            margin-bottom: 20px;
        }

        #pieChartContainer {
            flex: 1;
            height: 300px;
            margin-top: 0;
        }

        #comparison-chart-wrapper {
            flex: 1;
            height: auto;
            display: flex;
            flex-direction: column;
        }

        #comparison-chart {
            margin: 0;
            height: 300px;
        }

        #comparison-result {
            margin-top: 10px;
            text-align: center;
        }

        .charts-container {
            margin-bottom: 0;
            transition: margin-bottom 0.3s ease;
        }

        .charts-container.expanded {
            margin-bottom: 20px;
        }

        .font-selector {
            position: fixed;
            top: 50px;
            right: 50px;
            z-index: 1000;
        }

        #fontSelector {
            padding: 8px;
            border-radius: 4px;
            background-color: #333;
            color: aliceblue;
            border: none;

        }

        .month-selector {
            text-align: center;
            margin-bottom: 20px;
        }

        .month-selector button {
            padding: 5px 15px;
            margin: 0 10px;
            background-color: #444;
            color: aliceblue;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .month-selector button:hover {
            background-color: #555;
        }

        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #444;
            border-radius: 8px;
            overflow: hidden;
        }

        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #555;
        }

        .expense-table th {
            background-color: #2c2c2c;
            font-weight: bold;
        }

        .expense-table tr:hover {
            background-color: #505050;
        }

        .expense-table input[type="checkbox"] {
            cursor: pointer;
        }

        .no-expenses {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        /* 添加側邊欄樣式 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100%;
            background-color: #444;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
        }

        /* 側邊欄區塊樣式 */
        .sidebar-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #333;
            border-radius: 8px;
        }

        /* 標題樣式 */
        .sidebar h2 {
            color: aliceblue;
            margin-bottom: 15px;
            font-size: 1.2em;
            padding-bottom: 8px;
            border-bottom: 1px solid #555;
        }

        /* 類別選項樣式 */
        .category-options {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .category-options label {
            margin-bottom: 8px;
            color: aliceblue;
        }

        /* 輸入框和下拉選單統一樣式 */
        .sidebar input[type="number"],
        .sidebar input[type="text"],
        .sidebar input[type="date"],
        .sidebar select {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border: none;
            border-radius: 4px;
            background-color: #555;
            color: aliceblue;
            font-size: 14px;
            box-sizing: border-box;
        }

        /* 按鈕樣式 */
        .sidebar button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: #666;
            color: aliceblue;
            cursor: pointer;
            font-size: 14px;
        }

        .sidebar button:hover {
            background-color: #777;
        }

        /* 滾動條樣式 */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #444;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* 主內容區域 */
        .main-content {
            margin-left: 270px;
            padding: 20px;
        }

        /* 調整現有元素樣式 */
        .font-selector {
            right: 20px;
        }

        /* 自定義側邊欄滾動條樣式 */
        .sidebar::-webkit-scrollbar {
            width: 8px;
            /* 滾動條寬度 */
        }

        .sidebar::-webkit-scrollbar-track {
            background: #444;
            /* 滾動條軌道背景色 */
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #666;
            /* 滾動條顏色 */
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #777;
            /* 滾動條懸停時的顏色 */
        }

        /* 類別選項樣式 */
        .category-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 選項之間的間距 */
            margin-bottom: 15px;
        }

        .category-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: aliceblue;
        }

        /* 圖表容器的滾動條樣式 */
        #chartContainer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            /* 添加水平滾動條的高度 */
        }

        #chartContainer::-webkit-scrollbar-track {
            background: #444;
            border-radius: 4px;
        }

        #chartContainer::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        #chartContainer::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* 比較圖表的滾動條樣式 */
        #comparison-chart::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #comparison-chart::-webkit-scrollbar-track {
            background: #444;
            border-radius: 4px;
        }

        #comparison-chart::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        #comparison-chart::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .category-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .category-btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: #555;
            color: aliceblue;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .category-btn:hover {
            background-color: #666;
        }

        .salary-btn {
            background-color: #2d6a4f;
        }

        .salary-btn:hover {
            background-color: #40916c;
        }

         .quick-amount-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 5px;
            margin: 10px 0;
            width: 100%;
        }

        .sidebar-section .amount-btn {
            width: 100%;
            padding: 8px 5px;
            background-color: #555;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
            box-sizing: border-box;
        }

        .amount-btn:hover {
            background-color: #666;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-section">
            <h2>新增支出/預約</h2>
            <input type="date" id="expenseDate" value="">
            <input type="number" id="expenseAmount" placeholder="金額">
            <div class="quick-amount-buttons">
                    <button class="amount-btn" onclick="addAmount(1000)">+1000</button>
                    <button class="amount-btn" onclick="addAmount(500)">+500</button>
                    <button class="amount-btn" onclick="addAmount(100)">+100</button>
                    <button class="amount-btn" onclick="addAmount(50)">+50</button>
                    <button class="amount-btn" onclick="addAmount(10)">+10</button>
            </div>
            <input type="text" id="expenseNote" placeholder="備註 (可選)">
            <div class="category-buttons">
                <button class="category-btn" onclick="addExpenseWithCategory('交通')">交通</button>
                <button class="category-btn" onclick="addExpenseWithCategory('早餐')">早餐</button>
                <button class="category-btn" onclick="addExpenseWithCategory('中餐')">中餐</button>
                <button class="category-btn" onclick="addExpenseWithCategory('晚餐')">晚餐</button>
                <button class="category-btn" onclick="addExpenseWithCategory('投資')">投資</button>
                <button class="category-btn" onclick="addExpenseWithCategory('零食')">零食</button>
                <button class="category-btn" onclick="addExpenseWithCategory('娛樂')">娛樂</button>
                <button class="category-btn" onclick="addExpenseWithCategory('飲料')">飲料</button>
                <button class="category-btn salary-btn" onclick="addExpenseWithCategory('薪水')">薪水</button>
                <button class="category-btn salary-btn" onclick="addExpenseWithCategory('bonus')">Bonus</button>
            </div>
        </div>
        <div class="sidebar-section">
            <h2>類別篩選</h2>
            <select id="category-select">
                <option value="">全部</option>
                <!-- 程式會動態填充選項 -->
            </select>
        </div>
    </div>

    <!-- 將現有內容包裝在 main-content div 中 -->
    <div class="main-content">
        <!-- 將原本的新增支出和預約扣款表單從這裡移除 -->
        <!-- 保留其他所有內容 -->
        <h1>local accounting system</h1>
        <p id="todayDate"></p>
        <p id="monthlyTotal"></p>
        <h1 id="monthlyRemaining"></h1>
        <div class="font-selector">
            <select id="fontSelector" onchange="changeFont()">
                <option value="Arial">Arial</option>
                <option value="Courier New">Courier New</option>
                <option value="Georgia">Georgia</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Verdana">Verdana</option>
            </select>
        </div>

        <div class="charts-container">
            <div class="month-selector">
                <button onclick="changeMonth(-1)">上個月</button>
                <span id="currentMonthDisplay"></span>
                <button onclick="changeMonth(1)">下個月</button>
            </div>
            <div id="chartContainer" onmouseover="showOtherCharts()" onmouseleave="hideOtherCharts()">
                <canvas id="lineChart"></canvas>
            </div>

            <div class="charts-row" id="additional-charts">
                <div id="pieChartContainer" onmouseover="showOtherCharts()" onmouseleave="hideOtherCharts()">
                    <canvas id="pieChart"></canvas>
                </div>

                <div id="comparison-chart-wrapper">
                    <canvas id="comparison-chart" onmouseover="showOtherCharts()"
                        onmouseleave="hideOtherCharts()"></canvas>
                    <h3 id="comparison-result"></h3>
                </div>
            </div>
        </div>

        <h2>今日支出</h2>
        <button id="clearSelectedBtn" onclick="clearSelected()">清除勾選的今日項目</button>
        <div id="expenseList"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartInstance = null;
        let pieChartInstance = null;
        let currentDisplayMonth = new Date(); // 當前顯示的月份

        function changeFont() {
            const selectedFont = document.getElementById("fontSelector").value;
            document.body.style.fontFamily = selectedFont;

            if (chartInstance) {
                chartInstance.options.plugins.title.font.family = selectedFont;
                chartInstance.options.plugins.legend.labels.font.family = selectedFont;
                chartInstance.update();
            }

            if (pieChartInstance) {
                pieChartInstance.options.plugins.title.font.family = selectedFont;
                pieChartInstance.options.plugins.legend.labels.font.family = selectedFont;
                pieChartInstance.update();
            }
        }

        function renderChart() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];

            // 獲取當前月份的天數
            const daysInMonth = new Date(
                currentDisplayMonth.getFullYear(),
                currentDisplayMonth.getMonth() + 1,
                0
            ).getDate();

            const selectedMonthData = getMonthlyData(data, currentDisplayMonth, false);
            const selectedMonthWithScheduled = getMonthlyData(data, currentDisplayMonth, true);

            const lastMonth = new Date(currentDisplayMonth);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthData = getMonthlyData(data, lastMonth, false);

            const ctx = document.getElementById("lineChart").getContext("2d");

            if (chartInstance) {
                chartInstance.data.labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                chartInstance.data.datasets[0].data = selectedMonthData.slice(0, daysInMonth);
                chartInstance.data.datasets[1].data = lastMonthData.slice(0, daysInMonth);
                chartInstance.data.datasets[2].data = selectedMonthWithScheduled.slice(0, daysInMonth);
                chartInstance.options.plugins.title.text =
                    `${currentDisplayMonth.getFullYear()}年${currentDisplayMonth.getMonth() + 1}月支出趨勢圖`;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: daysInMonth }, (_, i) => i + 1),
                        datasets: [
                            {
                                label: "本月 (實際支出)",
                                data: selectedMonthData.slice(0, daysInMonth),
                                borderColor: "orange",
                                fill: false
                            },
                            {
                                label: "上月 (實際支出)",
                                data: lastMonthData.slice(0, daysInMonth),
                                borderColor: "yellow",
                                fill: false
                            },
                            {
                                label: "本月 (含預約扣款)",
                                data: selectedMonthWithScheduled.slice(0, daysInMonth),
                                borderColor: "blue",
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '日期 (日)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金額 (元)'
                                },
                                ticks: {
                                    stepSize: 1000
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    font: {
                                        family: "Arial"
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: "月支出趨勢圖",
                                font: {
                                    family: "Arial"
                                }
                            }
                        }
                    }
                });
            }
        }
        // 初始化，填充下拉選單
        function initializeCategorySelector() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const uniqueCategories = Array.from(new Set(data.map(expense => expense.category)));
            const selectElement = document.getElementById("category-select");
            selectElement.innerHTML = ""; // 確保不會重複添加選項
            const allOption = document.createElement("option");
            allOption.value = "";
            allOption.textContent = "全部";
            selectElement.appendChild(allOption);
            uniqueCategories.forEach(category => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });

            // 監聽下拉選單的變化
            selectElement.addEventListener("change", () => {
                generateComparison(selectElement.value);
            });

            // 初次生成圖表
            generateComparison("");
        }
        // 根據選擇的類別生成圖表
        function generateComparison(selectedCategory) {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];

            // 使用 currentDisplayMonth 作為當前月份
            const currentMonth = currentDisplayMonth.toISOString().slice(0, 7);

            // 計算上個月
            const lastMonth = new Date(currentDisplayMonth);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().slice(0, 7);

            // 過濾本月與上月數據
            const currentMonthData = data.filter(
                expense =>
                    expense.date.startsWith(currentMonth) &&
                    (selectedCategory === "" || expense.category === selectedCategory)
            );
            const lastMonthData = data.filter(
                expense =>
                    expense.date.startsWith(lastMonthStr) &&
                    (selectedCategory === "" || expense.category === selectedCategory)
            );

            // 計算每個類別的支出總額
            function calculateCategoryTotals(expenses) {
                return expenses.reduce((totals, expense) => {
                    if (!totals[expense.category]) {
                        totals[expense.category] = 0;
                    }
                    const amount = expense.category === "薪水" ?
                        expense.amount : Math.abs(expense.amount);
                    totals[expense.category] += amount;
                    return totals;
                }, {});
            }

            const currentMonthTotals = calculateCategoryTotals(currentMonthData);
            const lastMonthTotals = calculateCategoryTotals(lastMonthData);

            // 獲取類別（僅擇的類別或全部）
            const allCategories = selectedCategory
                ? [selectedCategory]
                : Array.from(new Set([...Object.keys(currentMonthTotals), ...Object.keys(lastMonthTotals)]));

            // 准備圖表數據
            const currentMonthValues = allCategories.map(category => currentMonthTotals[category] || 0);
            const lastMonthValues = allCategories.map(category => lastMonthTotals[category] || 0);

            // 計算百分比變化
            const percentageChanges = allCategories.map(category => {
                const lastMonthValue = lastMonthTotals[category] || 0;
                const currentMonthValue = currentMonthTotals[category] || 0;
                if (lastMonthValue === 0) {
                    return currentMonthValue === 0 ? 0 : 100; // 如果上月和本月都是 0，變化為 0%；如果上月是 0，本月非 0，變化為 100%
                }
                return ((currentMonthValue - lastMonthValue) / Math.abs(lastMonthValue)) * 100;
            });

            // 檢查是否有現存的圖表，並銷毀它
            const chartCanvas = document.getElementById("comparison-chart");
            if (chartCanvas.chartInstance) {
                chartCanvas.chartInstance.destroy();
            }
            const ctx = document.getElementById("comparison-chart").getContext("2d");
            const currentChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: allCategories,
                    datasets: [
                        {
                            label: "本月",
                            data: currentMonthValues,
                            backgroundColor: "orange",
                            borderWidth: 1,
                            borderRadius: 15, // 設定柱狀圖圓角
                            borderSkipped: false, // 使柱狀圖的頭尾圓潤
                        },
                        {
                            label: "上月",
                            data: lastMonthValues,
                            backgroundColor: "yellow",
                            borderWidth: 1,
                            borderRadius: 15,
                            borderSkipped: false,
                        },
                    ],
                },
                options: {
                    indexAxis: "y", // 橫向柱狀圖
                    responsive: true,

                    scales: {
                        x: {
                            beginAtZero: true,
                            reverse: true, // X 軸反轉，實現由右到左
                        },
                        y: {
                            beginAtZero: true,
                        },
                    },
                },
            });
            // 保存當前圖表實例到畫布元素
            document.getElementById("comparison-chart").chartInstance = currentChart;
            // 顯示百分比比結果
            const comparisonResult = allCategories
                .map((category, index) => {
                    const percentage = percentageChanges[index].toFixed(2); // 保留兩位小數
                    return `${category}: ${percentage >= 0 ? "+" : ""}${percentage}%`;
                })
                .join("<br>");
            document.getElementById("comparison-result").innerHTML = "比較結果（百分比）：<br>" + comparisonResult;
        }

        // 初化
        initializeCategorySelector();

        function addExpenseWithCategory(category) {
            const expenseDate = document.getElementById("expenseDate").value;
            const expenseAmount = parseFloat(document.getElementById("expenseAmount").value);
            const expenseNote = document.getElementById("expenseNote").value || "無備註";
            const today = new Date().toISOString().split("T")[0];

            if (!expenseAmount || isNaN(expenseAmount)) {
                alert("請輸入有效的金額！");
                return;
            }

            if (!expenseDate) {
                alert("請選擇日期！");
                return;
            }

            const isIncome = category === "薪水" || category === "bonus";
            const expenseType = expenseDate > today ? "scheduled" : "actual";

            const expense = {
                date: expenseDate,
                amount: isIncome ? Math.abs(expenseAmount) : -Math.abs(expenseAmount),
                category: category,
                note: expenseNote,
                type: expenseType
            };

            let data = JSON.parse(localStorage.getItem("expenses")) || [];
            data.push(expense);
            localStorage.setItem("expenses", JSON.stringify(data));

            alert(expenseType === "scheduled" ? "預約支出已新增！" : "支出已新增！");

            // 清空表單輸入欄位
            document.getElementById("expenseDate").value = today;
            document.getElementById("expenseAmount").value = "";
            document.getElementById("expenseNote").value = "";

            // 更新視圖
            renderTodayExpenses();
            displaySummary();
            renderChart();
            renderPieChart();
            initializeCategorySelector();
        }

        // 在頁面載入時設置日期預設值為今天
        document.addEventListener("DOMContentLoaded", () => {
            const expenseDateInput = document.getElementById("expenseDate");
            const today = new Date().toISOString().split("T")[0];
            expenseDateInput.value = today;
        });

        function renderPieChart() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            // 使用 currentDisplayMonth 替代當前月份
            const currentMonth = currentDisplayMonth.toISOString().slice(0, 7);
            const today = new Date().toISOString().split("T")[0];

            // 過濾選中月份的資料
            const filteredData = data.filter(expense => {
                if (expense.category === "薪水") return false;
                if (expense.type === "scheduled" && expense.date === today) return true;
                return expense.date.startsWith(currentMonth);
            });

            // 計算類別總支出
            const categoryTotals = {};
            filteredData.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + Math.abs(expense.amount);
            });

            const ctx = document.getElementById("pieChart").getContext("2d");

            if (pieChartInstance) {
                pieChartInstance.data.labels = Object.keys(categoryTotals);
                pieChartInstance.data.datasets[0].data = Object.values(categoryTotals);
                pieChartInstance.update();
            } else {
                pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            data: Object.values(categoryTotals),
                            backgroundColor: ["#640D5F", "#D91656", "#EB5B00", "#FFB200", "#0066CC","#8B3A62","#F06277","#FF914D","#FFD966","#0082C8"],   
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: "top",
                                labels: {
                                    font: {
                                        family: "Arial"
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: "本月支出比例 (含今日預約扣款)",
                                font: {
                                    family: "Arial"
                                }
                            }
                        }
                    }
                });
            }
        }


        function renderTodayExpenses() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const selectedMonth = currentDisplayMonth.toISOString().slice(0, 7); // 獲取選中月份 YYYY-MM 格式

            // 過濾中月份的支出
            const monthlyExpenses = data.filter(expense => expense.date.startsWith(selectedMonth));

            // 按日期升序排列
            const sortedExpenses = monthlyExpenses.sort((a, b) => new Date(a.date) - new Date(b.date));

            const expenseList = document.getElementById("expenseList");

            // 果該月沒有支出記
            if (sortedExpenses.length === 0) {
                expenseList.innerHTML = `<div class="no-expenses">本月尚無支出記錄</div>`;
                return;
            }

            // 生成表格形式的支出列表
            const tableHTML = `
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th>選擇</th>
                            <th>日期</th>
                            <th>類型</th>
                            <th>類別</th>
                            <th>金額</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedExpenses.map((expense, index) => `
                            <tr>
                                <td><input type="checkbox" id="expense-${index}"></td>
                                <td>${expense.date}</td>
                                <td>${expense.type === "scheduled" ? "預約扣款" : "實際支出"}</td>
                                <td>${expense.category}</td>
                                <td>${Math.abs(expense.amount)} 元</td>
                                <td>${expense.note}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;

            expenseList.innerHTML = tableHTML;
        }


        function clearSelected() {
            const checkboxes = document.querySelectorAll("input[type='checkbox']:checked");
            let data = JSON.parse(localStorage.getItem("expenses")) || [];

            checkboxes.forEach(checkbox => {
                const index = checkbox.id.split("-")[1];
                data.splice(index, 1); // 根據索引除對應支出
            });

            localStorage.setItem("expenses", JSON.stringify(data));
            renderTodayExpenses(); // 重新渲支出列表
            displaySummary(); // 更新月總結
            renderChart(); // 更新折線圖
            renderPieChart(); // 更新圓餅圖
        }

        function displaySummary() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const today = new Date();
            const month = today.toISOString().slice(0, 7);
            const todayDate = today.toISOString().split("T")[0];

            // 當月資料
            const monthlyExpenses = data.filter(expense => expense.date.startsWith(month));

            // 獲取薪水和 bonus 總額
            const income = monthlyExpenses
                .filter(expense => (expense.category === "薪水" || expense.category === "bonus") && expense.type === "actual")
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 實際支出 (負數，非薪水和非 bonus)
            const actualExpenses = monthlyExpenses
                .filter(expense => expense.type === "actual" && expense.category !== "薪水" && expense.category !== "bonus")
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 當日預約扣款 (負)
            const todayScheduledExpenses = data
                .filter(expense => expense.type === "scheduled" && expense.date === todayDate)
                .reduce((sum, expense) => sum + expense.amount, 0);

            // 剩餘金額 = 收入(薪水+bonus) - 實際支出 - 當日預約扣款
            const remaining = income - Math.abs(actualExpenses) - Math.abs(todayScheduledExpenses);

            // 更新顯示
            document.getElementById("todayDate").textContent = "今日日期：" + todayDate;
            document.getElementById("monthlyTotal").textContent = "本月總消費金額：" + Math.abs(actualExpenses + todayScheduledExpenses) + " 元";
            document.getElementById("monthlyRemaining").textContent = "本月剩餘金額：" + remaining + " 元";
        }


        function init() {
            const data = JSON.parse(localStorage.getItem("expenses")) || [];
            const today = new Date().toISOString().split("T")[0];

            // 檢查當日預約扣款，並將其轉為實際支出
            let updated = false;
            data.forEach(expense => {
                if (expense.type === "scheduled" && expense.date === today) {
                    expense.type = "actual"; // 更新為實際支出
                    updated = true;
                }
            });

            if (updated) {
                localStorage.setItem("expenses", JSON.stringify(data)); // 保存變更
            }

            // 依次更新視圖
            renderTodayExpenses();
            displaySummary();
            renderChart();
            renderPieChart(); // 確保圓餅圖更新
            renderScheduledExpenses(); // 更新預約扣款列表
            updateMonthDisplay(); // 添加這行
        }

        init();

        function showOtherCharts() {
            const additionalCharts = document.getElementById('additional-charts');
            const chartsContainer = document.querySelector('.charts-container');
            additionalCharts.classList.add('visible');
            chartsContainer.classList.add('expanded');
        }

        function hideOtherCharts() {
            const additionalCharts = document.getElementById('additional-charts');
            const chartsContainer = document.querySelector('.charts-container');
            additionalCharts.classList.remove('visible');
            chartsContainer.classList.remove('expanded');
        }

        function changeMonth(delta) {
            currentDisplayMonth.setMonth(currentDisplayMonth.getMonth() + delta);
            updateMonthDisplay();
            renderChart();
            renderPieChart();
            generateComparison(document.getElementById("category-select").value);
            renderTodayExpenses();
        }

        function updateMonthDisplay() {
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月",
                "七月", "八月", "九月", "十月", "十一月", "十二月"];
            document.getElementById("currentMonthDisplay").textContent =
                `${currentDisplayMonth.getFullYear()}年 ${monthNames[currentDisplayMonth.getMonth()]}`;
        }

        function getMonthlyData(data, date, includeScheduled) {
            const month = date.toISOString().slice(0, 7);
            const today = new Date().toISOString().split("T")[0];
            const daysInMonth = new Date(
                date.getFullYear(),
                date.getMonth() + 1,
                0
            ).getDate();

            const dailyTotals = Array(daysInMonth).fill(0);

            data.filter(expense => expense.date.startsWith(month))
                .forEach(expense => {
                    const day = parseInt(expense.date.split("-")[2]);
                    if (!includeScheduled && expense.type === "scheduled" && expense.date !== today) return;
                    if (day <= daysInMonth) { // 確保日期在當月範圍內
                        dailyTotals[day - 1] += expense.amount;
                    }
                });

            return dailyTotals;
        }

        function addAmount(value) {
            const amountInput = document.getElementById("expenseAmount");
            const currentAmount = parseFloat(amountInput.value) || 0;
            amountInput.value = currentAmount + value;
        }
    </script>
</body>

</html>
